<div class="chat-container flex flex-col md:flex-row gap-3 container mx-auto p-4">
  <!-- Online users list -->
  <div class="md:w-[250px] w-fit-content">
    <p-panel header="Chats">
      @if(chatUsers().length === 0){
      <div class="text-gray-500">
        <p>No available chats.</p>
      </div>
      }@else{<p-listbox
        [options]="chatUsers()"
        [(ngModel)]="selectedUser"
        optionLabel="username"
        (ngModelChange)="selectUser($event)"
      >
        <ng-template let-user pTemplate="item">
          <div class="flex items-center justify-between gap-2 w-full">
            <div class="flex items-center gap-2">
              <span>{{ user.username }}</span>
            </div>
            <span
              class="inline-block w-2.5 h-2.5 rounded-full"
              [ngClass]="isUserOnline(user) ? 'bg-green-500' : 'bg-gray-400'"
              title="{{ isUserOnline(user) ? 'Online' : 'Offline' }}"
            ></span>
          </div>
        </ng-template> </p-listbox
      >}
    </p-panel>
  </div>

  <!-- Chat section -->
  <div class="w-full">
    <p-panel
      [header]="selectedUser() ? selectedUser()?.username : 'Select a user to start chatting'"
    >
      @if(selectedUser()){
      <div
        class="messages-container flex flex-col gap-2 h-96 overflow-y-auto px-2"
        #messagesContainer
      >
        @for(message of messages(); track $index){
        <div
          (click)="toggleDate($index)"
          [ngClass]="{
            'self-end message-sent': message.sender.userId === currentUser()?.userId,
            'self-start message-received': message.sender.userId !== currentUser()?.userId
          }"
          class="p-2 rounded-lg max-w-xs flex flex-col items-end hover:cursor-pointer"
        >
          <span>{{ message.messageText }}</span>

          @if(showDateIndex === $index){
          <span class="text-xs">
            {{ message.sentAt | hourOnlyPipe }}
          </span>
          }
        </div>
        }
      </div>

      <div class="input-container flex gap-2 items-center mt-4">
        <input
          pInputText
          placeholder="Type your message..."
          [(ngModel)]="messageText"
          (keydown.enter)="sendMessage(); $event.preventDefault()"
          class="flex-1 border rounded p-2"
        />
        <app-emoji-picker [emojiSignal]="messageText"></app-emoji-picker>
        <button
          pButton
          icon="pi pi-sparkles"
          severity="secondary"
          class="h-10"
          [loading]="isGeneratingReply()"
          (click)="generateAiReply()"
          title="Generate AI reply"
        ></button>

        <button
          pButton
          icon="pi pi-send"
          (click)="sendMessage()"
          [disabled]="!messageText()"
          class="h-10"
        ></button>
      </div>
      }@else{
      <div class="text-center text-gray-500 p-3">
        <i class="pi pi-comments text-3xl mb-2"></i>
        <p>Select a user from the list to start chatting.</p>
      </div>
      }
    </p-panel>
  </div>
</div>
